# uofリポジトリ 引き継ぎドキュメント (改訂版)

## 1. はじめに

このドキュメントは、`uof`リポジトリで行われているMATLABベースの太陽光発電(PV)出力予測誤差に関する一連の解析処理について、第三者がその内容を正確に理解し、実行・改修を円滑に引き継ぐことを目的としています。

本改訂版では、各MATLABスクリプトに詳細なコメントを追加した上で、処理の全体像、具体的な実行手順、そして最も重要な注意点である**パスの修正箇所**を明確にしました。

## 2. プロジェクトの全体像

このプロジェクトは、PVの「予測出力」と「実績出力」から「予測誤差」を算出し、その誤差の特性を統計的に分析することで、電力系統の安定化（LFC制御）に必要な調整力の評価に繋げるものです。

処理の全体フローは、大きく**「①データ生成」**、**「②詳細分析」**、**「③可視化・評価」**の3段階に分かれます。

```mermaid
graph TD
    subgraph ① データ生成チェーン（最重要）
        A[外部データ<br>Radiation_fcst, PR, PV_base] --> B(PV_forecast_make.m);
        B --> C{PV_forecast_YYYY.mat<br>(予測出力)};
        D[外部データ<br>Pv_real_out, PV_capa] --> E(PV_make.m);
        E --> F{PV_YYYY.mat<br>(実績出力)};
        G[外部データ<br>Load_YYYY] --> H(PV_forecast_error_make.m);
        C --> H;
        F --> H;
        H --> I((ERROR_YYYY.mat<br>基準予測誤差));
    end

    subgraph ② 詳細分析フェーズ
        I --> J(PV_forecast_error_PVup_make.m);
        J --> K{ERRORyyyymmdd.mat<br>(日別・容量別誤差)};
        I --> L(SIGMA_get.m / SIGMA_get1.m);
        L --> M{error_sigma.mat<br>(時間断面別σ)};
        N[外部データ<br>douteki_lfc_ab, new_ave*] --> O(douteki_LFC3.m);
        O --> P{LFC_amount_*.mat<br>(LFC必要量)};
    end

    subgraph ③ 可視化・評価フェーズ
        K --> Q(PV_compare.m / PV_forecast_error_bar_make.m);
        I --> R(yosoku_seido.m / MAE.m);
        Q --> S((グラフ出力));
        R --> S;
    end
```

## 3. ファイル構成

リポジトリ内の主要なファイルとその役割は以下の通りです。

### 3.1 MATLABスクリプト (`.m`ファイル)

| ファイル名 | 役割 | 区分 |
|:---|:---|:---|
| **PV_forecast_make.m** | **【Step 1】** 予測日射量から**予測PV出力**を生成する。 | データ生成 |
| **PV_make.m** | **【Step 2】** 実績データから**実績PV出力**を生成する（導入量補正）。 | データ生成 |
| **PV_forecast_error_make.m** | **【Step 3】** 予測と実績の差から**基準予測誤差**を計算する。 | データ生成 |
| PV_forecast_error_PVup_make.m | 基準誤差を基に、PV導入量別の**日別誤差ファイル**を生成する。 | 詳細分析 |
| SIGMA_get.m / SIGMA_get1.m | 予測誤差の**標準偏差(σ)**を計算する。 | 詳細分析 |
| douteki_LFC3.m | 予測誤差から**動的LFC必要量**を計算する。 | 詳細分析 |
| PV_compare.m | 予測と実績の比較グラフを描画する。 | 可視化 |
| PV_forecast_error_bar_make.m | 日別誤差の棒グラフを描画する。 | 可視化 |
| yosoku_seido.m / MAE.m | 予測精度を評価する（箱ひげ図、RMSEグラフ）。 | 可視化 |
| chose_data.m | 日付から行番号を取得するユーティリティ関数。 | 補助関数 |
| mode1_no_sigma.m / mode1_no_sigma1.m | σ計算の補助スクリプト（帯域分割処理）。 | 補助関数 |

### 3.2 MATLABデータ (`.mat`ファイル)

| 種別 | ファイル名 | 内容 |
|:---|:---|:---|
| **入力データ** | `data_YYYY.mat`, `PV_base_YYYY.mat`, `PR_YYYY.mat`, `Radiation_fcst_YYYY.mat`, `PV_capa_YYYY.mat`, `Pv_real_out_YYYY.mat`, `Load_YYYY.mat`, `douteki_lfc_ab.mat`, `new_ave_PV.mat`, `new_ave_load.mat` | 解析の起点となる外部データ。 | 
| **中間生成物** | `PV_forecast_YYYY.mat`, `PV_YYYY.mat` | データ生成チェーンの途中で作られる主要データ。 |
| **主要生成物** | `ERROR_YYYY.mat` | データ生成チェーンの最終成果物であり、詳細分析の入力となる。 |
| **最終成果物** | `ERRORyyyymmdd.mat`, `error_sigma.mat`, `LFC_amount_*.mat` | 各詳細分析の最終的な出力データ。 |

## 4. 実行手順（クイックスタート）

初めてこのプロジェクトを実行する際は、以下の手順に従ってください。

### Step 0: 環境設定【最重要】

一部のスクリプトには、開発者のローカルPCの絶対パスがハードコーディングされています。これを自分の環境に合わせて修正しないと、エラーが発生します。

1.  **`chose_data.m` を開く**
    - `cd C:\Users\PowerSystemLab\...` の行を、**自分の作業ディレクトリのパスに書き換える**か、またはこの行を**コメントアウト**してください。
2.  **`SIGMA_get.m`, `SIGMA_get1.m`, `douteki_LFC3.m`, `PV_compare.m`, `PV_forecast_error_bar_make.m` を開く**
    - 同様に、`cd C:\...` や `cd ..`、`cd (フォルダ名)` となっている箇所を、**自分の環境のディレクトリ構造に合わせて修正**してください。
    - 最も簡単な対策は、**すべての `cd` コマンドを削除・コメントアウト**し、MATLABの**カレントディレクトリを `uof` フォルダに設定**した上で、必要なサブフォルダ（`予測PV出力誤差_YYYY`, `動的LFC容量決定手法`）を手動で作成しておくことです。

### Step 1: 主要データの生成

MATLABのコマンドウィンドウで、以下のスクリプトを順番に実行します。（例: 2018年度）

```matlab
>> PV_forecast_make(2018)
% PV_forecast_2018.mat が生成される

>> PV_make(2018)
% PV_2018.mat が生成される

>> PV_forecast_error_make(2018)
% ERROR_2018.mat が生成される
```

### Step 2: 詳細分析の実行

`ERROR_2018.mat` ができたら、目的に応じて以下のスクリプトを実行します。

```matlab
% 例1: 日別・容量別誤差ファイルの生成
>> PV_forecast_error_PVup_make(2018)

% 例2: 6月のPV出力帯域別σの計算
>> SIGMA_get(2018, 1, 1, 6, 1.0)

% 例3: 6月15日のLFC必要量の計算
>> douteki_LFC3(2018, 6, 15, 1.0)
```

### Step 3: 可視化

分析結果をグラフで確認します。

```matlab
% 例1: 2018年6月の予測/実績比較
>> PV_compare(2018, 6, 1.0)

% 例2: 2018年の予測精度評価
>> yosoku_seido % スクリプト内でファイル名が固定されている点に注意
```

## 5. 引き継ぎ・改修時の重要注意点

このプロジェクトを引き継ぎ、改修する際には、以下の点に特に注意してください。

| 注意点 | 詳細と対策 |
|:---|:---|
| **パスのハードコーディング** | **最重要項目。** `chose_data.m` や `SIGMA_get.m` など、多数のファイルに `C:\Users\...` という絶対パスが記述されています。**必ず自分の環境に合わせて修正してください。** 対策として、全ての `cd` コマンドを削除し、MATLABのカレントディレクトリを固定して運用することを推奨します。 |
| **スクリプト形式のファイル** | `yosoku_seido.m` や `MAE.m` は関数ではなく、単体のスクリプトです。実行するとワークスペース上の変数を直接利用・上書きするため、意図しない動作を引き起こす可能性があります。**実行前にワークスペースをクリア (`clear`) するか、関数化 (`function`) することを検討してください。** |
| **ファイル名のハードコーディング** | `yosoku_seido.m` や `MAE.m` は、`'PV_2018.mat'` のようにファイル名を直接指定しています。他の年のデータで実行するには、**スクリプト内のファイル名を直接書き換える必要があります。** これらは年を引数として受け取る関数にリファクタリングすることが望ましいです。 |
| **グローバル変数の使用** | `chose_data.m` や `mode1_no_sigma.m` は、`global` 変数を使って呼び出し元と値をやり取りします。これはコードの依存関係を不透明にし、デバッグを困難にします。**可能な限り、関数の引数と戻り値でデータを渡すように修正することを推奨します。** |
| **外部関数の依存** | `PV_make.m` は、このリポジトリに含まれていない `Mabiki` という関数を呼び出します。**実行前に、この関数がMATLABのパス上にあることを確認してください。** |
| **計算ロジックの複雑さ** | `MAE.m` は変数名と計算式（実際はRMSE）が一致していません。`yosoku_seido.m` の100%超の誤差補正ロジックも直感的ではありません。**改修時には、まず計算式の意味を正確に理解し、必要であればコメントや変数名を修正してください。** |

## 6. まとめ

本プロジェクトは、PV予測誤差分析における一連のプロセスを網羅した貴重なコード資産です。しかし、開発者個人の環境に強く依存した箇所が多く、そのままでは再実行が困難です。

引き継ぎの最初のステップとして、**本ドキュメントの「Step 0: 環境設定」を確実に行い、パスの問題を解消すること**が最も重要です。その後、データ生成チェーンを実行し、プロジェクトの動作を実際に確認してください。

将来的には、本ドキュメントで指摘したハードコーディング箇所やグローバル変数の使用をリファクタリングし、より再利用性と保守性の高いコードベースに改善していくことを推奨します。
