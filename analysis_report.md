# NSDKIT/uofリポジトリ MATLABコード解析レポート

## 1. はじめに

本レポートは、GitHubリポジトリ `NSDKIT/uof` に格納されているMATLABコード群の構造、実行フロー、および各ファイルの役割を分析し、第三者への引き継ぎを容易にすることを目的としています。分析に基づき、コードの可読性向上と環境依存性の排除に向けた改善案を提示します。

## 2. リポジトリ構造の概要

リポジトリは、電力系統の需給運用に関するシミュレーションを実行するためのMATLABスクリプト、Simulinkモデル、および関連データファイルで構成されています。主要なディレクトリとその役割は以下の通りです。

| ディレクトリ名       | 役割                                                                 |
| -------------------- | -------------------------------------------------------------------- |
| `運用`               | シミュレーションのメインロジック、初期設定スクリプト、Simulinkモデルを格納。 |
| `UC立案/MATLAB`      | 発電機の起動停止計画（Unit Commitment）の最適化計算ロジックを格納。      |
| `基本データ`         | PV（太陽光発電）や需要の基本データ、各種係数などを格納。               |
| `PV実出力作成`       | 実測日射量データからPV実出力を計算するスクリプト群。                   |
| `予測PV出力作成`     | 気象予測データからPV予測出力を計算するスクリプト群。                   |
| `需要実績・予測作成` | 過去の需要実績から需要予測データを作成するスクリプト群。               |

## 3. 実行フローの分析

シミュレーションの実行は、リポジトリのルートディレクトリにある `model.m` スクリプトが起点となります。主要な処理の流れは以下の通りです。

1.  **初期設定 (`model.m`)**: シミュレーション対象の日付 (`YYYYMMDD`)、PV導入量 (`PVC`)、解析手法 (`meth_num`, `mode`) などのパラメータを設定します。

2.  **データ準備 (`model.m`)**: `基本データ` ディレクトリから、指定された年度のPV基本情報 (`PV_base_*.mat`)、システム出力係数 (`PR_*.mat`)、MSM（気象モデル）係数 (`MSM_bai_*.mat`) などを読み込みます。

3.  **入力データ生成**: `model.m` 内で、日射量データ (`irr_fore_data.mat`, `irr_mea_data.mat`) と需要データ (`D_1sec.mat`, `D_30min.mat`) を基に、シミュレーション当日のPV予測・実績、需要予測・実績を計算し、それぞれ `.mat` ファイルとして保存します。

4.  **起動停止計画 (`model.m` → `UC立案/MATLAB/new_optimization`)**: `UC立案/MATLAB` ディレクトリに移動し、`new_optimization` を実行して、経済性を考慮した発電機の起動停止計画を最適化計算します。結果は `G_Out.csv` などのCSVファイルに出力され、`運用` ディレクトリにコピーされます。

5.  **Simulink入力作成 (`運用/make_csv.m`)**: `運用` ディレクトリで `make_csv` を実行し、`demand_1sec.mat` と `PV_1sec.mat` からSimulinkモデル用の入力ファイル `Load.csv` と `PV_Out.csv` を生成します。

6.  **Simulink初期設定 (`運用/initset_*.m`シリーズ)**: `model.m` から `initset_dataload.m` が呼び出され、これを皮切りに一連の `initset_*.m` スクリプトが実行されます。これらは、Simulinkモデル (`AGC30_PVcut.slx`) の各コンポーネント（EDC, LFC, 発電機モデル, 慣性、連系線など）に必要なパラメータをワークスペースに読み込み、初期値を計算・設定します。

7.  **シミュレーション実行 (`model.m`)**: `sim('AGC30_PVcut.slx')` コマンドにより、Simulinkシミュレーションが実行されます。

8.  **結果保存 (`model.m`)**: シミュレーション結果（周波数変動 `dfout`、各発電機出力など）が、パラメータに応じたファイル名（例: `nSigma_2_Method_2_PVcapacity_5300_2019-8-28.mat`）で `H:\NSD_results` に保存されます。

## 4. 主要スクリプトとファイルの役割

| ファイル名/パス                               | 役割                                                                                                                             |
| --------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| `model.m`                                     | シミュレーション全体を制御するメインスクリプト。パラメータ設定、各処理モジュールの呼び出し、結果保存を行う。                       |
| `AGC30_PVcut.slx` (`運用/`)                   | 電力系統の周波数制御（LFC/EDC）を模擬する中心的なSimulinkモデル。                                                                  |
| `initset_dataload.m` (`運用/`)                | シミュレーション時間、需要・PV等の時系列データ、発電計画データ (`.csv`) を読み込み、Simulinkモデル用の入力 (`.mat`) を作成する。 |
| `initset_edc.m` (`運用/`)                     | 経済負荷配分制御（EDC）モデルの初期設定。起動・停止時のモード補正や、初期断面での需給バランス調整を行う。                     |
| `initset_lfc.m` (`運用/`)                     | 負荷周波数制御（LFC）モデルの各種ゲインや系統定数を設定する。                                                                    |
| `initset_thermals.m` (`運用/`)                | 汽力・GTCCプラントモデルの初期設定。`read_const_thermals.m` を呼び出して定数を読み込み、`init_thermals.m` で初期値を計算する。 |
| `new_optimization` (`UC立案/MATLAB/`)         | 発電機の起動停止計画（UC）を最適化するスクリプト。                                                                               |
| `定数.xlsx` (`運用/`)                         | 発電機モデルの各種物理パラメータ（ボイラ時定数、タービン出力分担率など）が定義されたExcelファイル。                              |

## 5. 課題と改善提案

### 5.1. 環境依存性の問題

- **絶対パスのハードコーディング**: `model.m` をはじめとする多くのスクリプト内に、`C:\Users\PowerSystemLab\...` や `H:\NSD_results` といった開発者のローカル環境に依存した絶対パスが記述されています。これにより、他の環境での再実行が著しく困難になっています。
- **文字コードの混在**: `運用` フォルダ配下のスクリプトの多くが `Shift-JIS` で保存されています。MATLABの標準である `UTF-8` 環境では文字化けやエラーの原因となります。

### 5.2. 可読性と保守性の問題

- **単一巨大スクリプト**: `model.m` は約450行に及び、パラメータ設定、データ処理、ループ制御、モジュール呼び出し、結果保存など、多数の役割を担っており、処理の流れを追うのが困難です。
- **コメント不足**: 各処理ブロックや変数が何を行っているのかについての説明が不足しており、コードの意図を理解するのが難しい箇所が散見されます。

### 5.3. 改善提案

1.  **メインスクリプトの再構築**: `model.m` をリファクタリングし、設定部、データ読み込み部、実行部を明確に分離した新しいメインスクリプト `run_simulation.m` を作成します。このスクリプトをリポジトリのルートに配置し、これを実行するだけで全ての処理が完結するようにします。

2.  **パスの相対化**: `run_simulation.m` の冒頭で `mfilename('fullpath')` を用いて基準パスを取得し、`addpath(genpath(pwd))` のようにしてサブフォルダへのパスを動的に追加します。全ての `cd` コマンドやハードコードされた絶対パスを削除し、相対パスでファイルアクセスするように全面的に修正します。

3.  **文字コードの統一**: リポジトリ内の全ての `.m` ファイルを `UTF-8` に変換・統一します。

4.  **コメントの充実とコード整形**: 各スクリプトの冒頭にその役割を記述し、主要な処理ブロックや複雑な計算部分に説明的なコメントを追加します。また、インデントを統一し、コードの可読性を向上させます。

5.  **不要ファイルの削除**: `parfor_model.m` のような現在使用されていないファイルや、`slprj` のようなSimulinkが自動生成するキャッシュフォルダを `.gitignore` に追加し、リポジトリから除外します。

これらの改善を実施することで、コードの属人性を排除し、第三者でも容易に内容を理解し、異なる環境でシミュレーションを再実行できる状態を目指します。
