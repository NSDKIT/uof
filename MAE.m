%% =========================================================
%  MAE.m  ―  月別平均絶対誤差率（RMSE）の計算・描画
%  =========================================================
%
%  【役割】
%    PVの予測出力と実績出力を比較し、月ごとの平均絶対誤差率を計算・描画する。
%    グラフのX軸は10月始まりで表示される（10, 11, 12, 1, 2, ..., 9月）。
%
%  【実行方法】
%    >> MAE   % ワークスペースに変数を読み込んでから実行
%
%  !! 【重要】このスクリプトは関数ではなくスクリプト形式 !!
%    実行するとワークスペース上の変数を直接書き換えるため、
%    他の変数と競合しないよう注意すること。
%
%  【前提条件（先に実行しておくこと）】
%    1. PV_forecast_make(2018)  → PV_forecast_2018.mat が存在すること
%    2. PV_make(2018)           → PV_2018.mat が存在すること
%
%  【入力ファイル（スクリプト内で直接 load している）】
%    PV_forecast_2018.mat  ← PV予測出力（変数: data_all → PV_F として使用）
%    PV_2018.mat           ← PV実績出力（変数: data_all → PV_O として使用）
%    data_2018.mat         ← 日付配列（変数: data）
%
%  !! 【重要】ファイル名が2018年にハードコーディングされている !!
%    他の年のデータで実行する場合は、スクリプト内の
%    'PV_forecast_2018.mat' / 'PV_2018.mat' / 'data_2018.mat' を手動で書き換えること。
%
%  【出力】
%    Figure 1: 月別の誤差率（RMSE）を折れ線グラフで表示
%              X軸: 月（10〜12月, 1〜9月の順）
%              Y軸: RMSE [%]（0〜120%）
%
%  !! 【注意】変数名と計算式の不一致 !!
%    変数名は mae だが、計算式は RMSE（二乗平均平方根誤差）:
%      RMSE = sqrt(Σ(実績-予測)² / N) / 平均実績 × 100 [%]
%    引き継ぎ時は計算式の意味を確認すること。
%
%  【計算対象時間帯】
%    6:00〜18:00（30分間隔の13〜37番目のデータ）に固定されている。
% =========================================================

%% --- データ読み込み ---
load('PV_forecast_2018.mat')  % 変数: data_all → PV予測出力
PV_F = data_all;              % 予測出力

load('PV_2018.mat')           % 変数: data_all → PV実績出力
PV_O = data_all;              % 実績出力

load('data_2018.mat')         % 変数: data → 日付配列

%% --- 月ごとに RMSE を計算（10月始まり） ---
M = [];
for month = [10:12, 1:9]
    % 当月の行番号を取得
    a = find(data(:,2)==month);
    PV_o1 = PV_O(a,:);  % 当月の実績出力
    PV_f1 = PV_F(a,:);  % 当月の予測出力
    d = length(a);       % 当月の日数

    % 6:00〜18:00 の時間帯のみ抽出（13〜37番目のデータ）
    pv_o = PV_o1(:, 13:37);  % 実績（昼間帯）
    pv_f = PV_f1(:, 13:37);  % 予測（昼間帯）

    % 日ごとに RMSE を計算
    m = [];
    for num = 1:d
        Pv_o = pv_o(num,:);
        Pv_f = pv_f(num,:);
        % RMSE [%] = sqrt(Σ(実績-予測)² / 25) / 平均実績 × 100
        mae = sqrt(sum((Pv_o - Pv_f).^2) / 25) / mean(Pv_o) * 100;
        m = [m; mae];
    end
    M = [M; mean(m)];  % 当月の日別RMSEの平均
end

%% --- 月別 RMSE の折れ線グラフを描画 ---
figure, plot(M, 'bo-')
xlim([1 12])
xticks([1:12])
xticklabels([10:12, 1:9])  % X軸ラベルを10月始まりに設定
grid on
ylim([0 120])
