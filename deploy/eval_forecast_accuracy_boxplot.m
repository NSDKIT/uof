%% =========================================================
%  eval_forecast_accuracy_boxplot.m  ―  PV予測精度の評価（箱ひげ図・棒グラフ）
%  =========================================================
%
%  【役割】
%    PVの予測出力と実績出力を比較し、予測精度を評価するスクリプト。
%    主に箱ひげ図（boxplot）を用いて誤差の分布を可視化する。
%
%  【実行方法】
%    >> yosoku_seido   % ワークスペースに変数を読み込んでから実行
%
%  !! 【重要】このスクリプトは関数ではなくスクリプト形式 !!
%    実行するとワークスペース上の変数を直接書き換えるため、
%    他の変数と競合しないよう注意すること。
%
%  【前提条件（先に実行しておくこと）】
%    1. step1_generate_pv_forecast(2018)  → PV_forecast_2018.mat が存在すること
%    2. step2_generate_pv_actual(2018)           → PV_2018.mat が存在すること
%
%  【入力ファイル（スクリプト内で直接 load している）】
%    PV_2018.mat          ← PV実績出力（変数: data_all → PV_o として使用）
%    PV_forecast_2018.mat ← PV予測出力（変数: data_all → PV_f として使用）
%
%  !! 【重要】ファイル名が2018年にハードコーディングされている !!
%    他の年のデータで実行する場合は、スクリプト内の
%    'PV_2018.mat' / 'PV_forecast_2018.mat' を手動で書き換えること。
%
%  【出力】
%    Figure 1: 7:00〜17:30 の時間帯における誤差率の箱ひげ図（365日分）
%    Figure 2: 同時間帯の平均誤差率の棒グラフ
%
%  【計算方法】
%    誤差率 = |予測 - 実績| / 予測 × 100 [%]
%    ※ 100%超の場合は (100 - (誤差 - 100)) として補正される
%    ※ NaN / Inf は 0 に置換される
%
%  !! 【注意】改良が必要な箇所 !!
%    - ファイル名のハードコーディング（年を引数化すべき）
%    - 100%超の誤差補正ロジックが複雑で直感的でない
%    - 関数化されていないため、ワークスペースを汚染する
% =========================================================

%% --- データ読み込み（相対パス: output フォルダ） ---
% 注意: 年度が2018年にハードコーディングされている。
%       他の年度のデータで実行する場合は以下の '2018' を変更すること。
load(fullfile('output', 'PV_2018.mat'))          % 変数: data_all → PV実績出力
PV_o = data_all;                                  % 実績出力

load(fullfile('output', 'PV_forecast_2018.mat')) % 変数: data_all → PV予測出力
PV_f = data_all;                                  % 予測出力

%% --- 日ごとに誤差率を計算 ---
E = [];
for num = 1:365
    p_f = PV_f(num,:);   % 当日の予測出力
    p_o = PV_o(num,:);   % 当日の実績出力

    % 誤差率 [%] = |予測 - 実績| / 予測 × 100
    error = abs(p_f(1:48) - p_o) ./ p_f(1:48) * 100;

    % NaN 処理（予測=0 の時間帯など）
    error(isnan(error)) = 0;

    % Inf 処理（予測=0 の時間帯など）
    error(~isfinite(error)) = 0;

    % 100%超の誤差を補正（100% を超えた分を折り返す）
    error(find(error>100)) = error(find(error>100)) - 100;
    error = 100 - error;

    E = [E; error];
end

%% --- 7:00〜17:30 の時間帯のみ抽出して可視化 ---
% 30分間隔の場合: 7:00 = 15番目, 17:30 = 35番目
e = E(:, 15:35);

% 箱ひげ図: 各時間断面の誤差分布を可視化
figure, boxplot(e)

% 棒グラフ: 各時間断面の平均誤差率
ee = mean(e);
figure, bar(ee)
