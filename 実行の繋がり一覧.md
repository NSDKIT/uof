# 予測PV出力誤差フォルダ ― 実行の繋がり一覧

フォルダ内の「どれを実施したら次にどれが実施されてどうなるか」を、**データの流れ**と**実行順**で整理したものです。

---

## 1. 前提：フォルダ外で用意するデータ

このフォルダの処理が使う、**外から用意する .mat / 関数**です。

| ファイル/名前 | 使う処理 |
|---------------|----------|
| `data_YYYY.mat` | ほぼ全般（日付・行番号用） |
| `PV_base_YYYY.mat` | PV_forecast_make, PV_forecast_error_make |
| `PR_YYYY.mat` | PV_forecast_make |
| `Radiation_fcst_YYYY.mat` | PV_forecast_make |
| `PV_capa_YYYY.mat` | PV_make, PV_forecast_error_PVup_make |
| `Pv_real_out_YYYY.mat` | PV_make, PV_real_form |
| `Load_YYYY.mat` | PV_forecast_error_make, PV_compare |
| `PVC.mat` | mode1_no_sigma1 |
| `time_label.mat` | mode1_no_sigma, mode1_no_sigma1 |
| `douteki_lfc_ab.mat` | douteki_LFC3 |
| `new_ave_PV`, `new_ave_load.mat` | douteki_LFC3 |
| 関数: `Mabiki` | PV_make |
| 関数: `KAKURITUBU_BUNNPU` / `KAKURITUBU_BUNNPU1` | mode1_no_sigma, mode1_no_sigma1, SIGMA_get |
| 関数: `sec_time_30min`, `get_color` 等 | 各スクリプト |

---

## 2. メインの実行チェーン（推奨順）

### 2.1 データ作成の流れ（1本線）

```
[外部データ]
  data_YYYY, PV_base_YYYY, PR_YYYY, Radiation_fcst_YYYY
      │
      ▼
① PV_forecast_make(YYYY)
      │ 出力: PV_forecast_YYYY.mat
      ▼
[外部] PV_capa_YYYY, Pv_real_out_YYYY, data_YYYY
      │
      ▼
② PV_make(YYYY)
      │ 出力: PV_YYYY.mat
      ▼
[外部] Load_YYYY.mat
      │
      ▼
③ PV_forecast_error_make(YYYY)
      │ 出力: ERROR_YYYY.mat
      ▼
  ここまでで「基準PV導入量での予測誤差」が揃う。
```

- **①→②→③** の順で実行すると、`PV_forecast_YYYY.mat` → `PV_YYYY.mat` → `ERROR_YYYY.mat` が作られ、以降の解析の土台になります。

### 2.2 日別・容量別誤差を作る枝（③の次）

```
③ ERROR_YYYY.mat ができている
      │
      ▼
④ PV_forecast_error_PVup_make(YYYY)
      入力: ERROR_YYYY, data_YYYY, PV_capa_YYYY
      内部: chose_data を利用
      出力: サブフォルダ「予測PV出力誤差_YYYY」に
            ERROR yyyy m d.mat（日別・容量別誤差）
```

- **③のあと**に **④** を実行すると、月・日・容量別の誤差ファイルが揃い、**PV_forecast_error_bar_make** や **PV_compare**（日別ERRORを読む場合）が使えます。

### 2.3 σ（シグマ）解析の流れ（③のあと）

```
③ ERROR_YYYY.mat ができている
      │
      ├──────────────────────────────────────────┐
      ▼                                          ▼
⑤a スクリプト mode1_no_sigma.m                  ⑤b スクリプト mode1_no_sigma1.m
   前提: ワークスペースに year, i, PVC_bai,      前提: ワークスペースに year, i, ERROR,
        ERROR を用意（ERROR_YYYY を load 等）         PV_forecast_YYYY, PVC.mat を用意
   読む: PV_forecast_YYYY.mat, time_label.mat    読む: PV_forecast_YYYY, PVC.mat,
   使う: KAKURITUBU_BUNNPU（帯域別σ・図）           chose_data → data_YYYY, time_label
                                                  使う: KAKURITUBU_BUNNPU1 等
      │                                          │
      ▼                                          ▼
  時間断面 i の「予測PV出力帯域別」σ・分布図     同様の解析（季節区切り等）
```

- **③のあと**、必要に応じて **⑤a** または **⑤b** を実行。  
- **⑥** は **⑤a** を内部で繰り返し呼びます。

```
③ ERROR_YYYY.mat ＋ ① PV_forecast_YYYY.mat ができている
      │
      ▼
⑥ SIGMA_get(YYYY, mode1, mode2, mode3, PVC_bai)
   入力: ERROR_YYYY, data_YYYY
   mode1==1 のとき: ループで「mode1_no_sigma」を 50 回実行
   出力: error_sigma.mat（動的LFC容量決定手法フォルダに保存）
```

- **⑥** は **③＋①** のあとで実行し、**⑤a（mode1_no_sigma）** を一括で回す入口になります。

同様に **SIGMA_get1(YYYY, ...)** は、**ERROR_YYYY** と **data_YYYY** を読んで別条件でσを計算します（**⑤b** とは別の関数として運用）。

---

## 3. 一覧表：入出力と「次にできること」

| 実施するもの | 入力（依存） | 出力 | 次に実施できること |
|-------------|--------------|------|--------------------|
| **PV_forecast_make(year)** | data_*, PV_base_*, PR_*, Radiation_fcst_* | PV_forecast_*.mat | PV_forecast_error_make, mode1_no_sigma(系), SIGMA_get, yosoku_seido, MAE, PV_compare |
| **PV_make(year)** | data_*, PV_capa_*, Pv_real_out_* | PV_*.mat | PV_forecast_error_make, yosoku_seido, MAE, PV_compare |
| **PV_forecast_error_make(year)** | PV_base_*, PV_forecast_*, PV_*, Load_*, data_* | ERROR_*.mat | PV_forecast_error_PVup_make, mode1_no_sigma(系), SIGMA_get, SIGMA_get1 |
| **PV_forecast_error_PVup_make(year)** | ERROR_*, data_*, PV_capa_*, chose_data | 予測PV出力誤差_YYYY/*.mat | PV_forecast_error_bar_make, PV_compare（日別ERROR利用時） |
| **chose_data(y,m,d)** | data_*.mat | ベースワークスペースに a_day | 単体では「次」なし。PV_compare, PV_forecast_error_PVup_make から呼ばれる |
| **mode1_no_sigma**（スクリプト） | year, i, PVC_bai, ERROR, PV_forecast_*, time_label | 図（σ・分布） | なし（可視化で完結） |
| **mode1_no_sigma1**（スクリプト） | year, i, ERROR, PV_forecast_*, PVC, data_*, time_label, chose_data | 図 | なし（可視化で完結） |
| **SIGMA_get(...)** | ERROR_*, data_*；mode1==1 時は mode1_no_sigma を利用 | error_sigma.mat（他フォルダ） | 動的LFC容量決定手法側の処理 |
| **SIGMA_get1(...)** | ERROR_*, data_* | error_sigma.mat | 同上 |
| **PV_compare(y,m,PV_bai)** | data_*, PV_forecast_*, PV_*, Load_*, chose_data；日別誤差を使う場合は ERROR y m d | 比較図 | なし（可視化で完結） |
| **PV_forecast_error_bar_make(y,m,num)** | 予測PV出力誤差_YYYY 内の ERROR y m d.mat | 棒グラフ | なし（可視化で完結） |
| **yosoku_seido**（スクリプト） | PV_2018, PV_forecast_2018 | 予測精度の図 | なし |
| **MAE**（スクリプト） | PV_forecast_2018, PV_2018, data_2018 | 月別MAEの図 | なし |
| **PV_real_form(year0)** | Pv_real_out_*, data_* | 実測PVの図 | なし |
| **douteki_LFC3(y,m,d,PV_bai)** | douteki_lfc_ab, new_ave_PV, new_ave_load | LFC_amount_*.mat（他フォルダ） | 動的LFC容量決定手法・シミュレーション側 |

---

## 4. 実行順の例（2018年で一通りの解析をする場合）

1. **PV_forecast_make(2018)**  
   → `PV_forecast_2018.mat` 作成  
2. **PV_make(2018)**  
   → `PV_2018.mat` 作成  
3. **PV_forecast_error_make(2018)**  
   → `ERROR_2018.mat` 作成  
4. 必要なら **PV_forecast_error_PVup_make(2018)**  
   → `予測PV出力誤差_2018/*.mat` 作成  
5. 解析・可視化（順不同）  
   - **SIGMA_get(2018, 1, …)** または **SIGMA_get1(2018, …)**  
   - **mode1_no_sigma** / **mode1_no_sigma1**（事前に year, i, ERROR 等を設定）  
   - **PV_compare(2018, 6, 1)** など  
   - **PV_forecast_error_bar_make(2018, 6, 1)**  
   - **yosoku_seido**, **MAE**（2018用データがあれば）  
   - **PV_real_form(2018)**  
6. LFC用に **douteki_LFC3(2018, 6, 1, 1)** 等（必要な日・倍率で）

---

## 5. 繋がりの簡易図（データの流れ）

```
[外部]
  data_*, PV_base_*, PR_*, Radiation_fcst_*, PV_capa_*, Pv_real_out_*, Load_*
        │
        ├──► PV_forecast_make ──► PV_forecast_*.mat
        │           │
        ├──► PV_make ──────────► PV_*.mat
        │           │                    │
        │           └────────┬───────────┘
        │                    ▼
        │         PV_forecast_error_make ──► ERROR_*.mat
        │                    │
        │                    ├──► PV_forecast_error_PVup_make ──► 予測PV出力誤差_*/*.mat
        │                    │                    │
        │                    │                    ├──► PV_forecast_error_bar_make
        │                    │                    └──► PV_compare（日別誤差利用時）
        │                    │
        │                    ├──► mode1_no_sigma（year,i,PVC_bai,ERROR を事前に設定）
        │                    ├──► mode1_no_sigma1（同様に設定）
        │                    ├──► SIGMA_get ──► error_sigma.mat
        │                    └──► SIGMA_get1 ──► error_sigma.mat
        │
        ├──► PV_compare（PV_forecast_*, PV_* があれば可能）
        ├──► yosoku_seido（PV_2018, PV_forecast_2018）
        ├──► MAE（同上）
        ├──► PV_real_form（Pv_real_out_*, data_*）
        │
        └──► douteki_LFC3（douteki_lfc_ab, new_ave_PV, new_ave_load）──► LFC_amount_*.mat
```

---

## 6. 補足

- **chose_data** は「日付→行番号」のユーティリティなので、単体では「次にこれ」はなく、**PV_compare** と **PV_forecast_error_PVup_make** の内部で使われます。
- **PV_compare** は、日別ファイル `ERROR y m d.mat` を使う場合は **PV_forecast_error_PVup_make** の実行後が前提です。`ERROR y m d.mat` は **PV_forecast_error_PVup_make** でサブフォルダ `予測PV出力誤差_YYYY` に保存されるため、**PV_compare** で読むときはカレントやパスを合わせる必要がある場合があります。
- **mode1_no_sigma** は **SIGMA_get** の mode1==1 時にスクリプトとして呼ばれるため、**SIGMA_get → mode1_no_sigma** の繋がりになっています。

この一覧に沿って実行すれば、「どれを実施したら次にどれが実施されてどうなるか」を一通り追えます。
